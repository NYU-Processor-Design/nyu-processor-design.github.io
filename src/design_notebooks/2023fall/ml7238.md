# Michael's Design Notebook

## Week of September 11, 2023

Project Work:
* [MEM/WB Latch Module](https://github.com/NYU-Processor-Design/nyu-core/pull/49): Completed and added the MEM/WB module and test to the core repository.
* [Control Module Design](https://github.com/NYU-Processor-Design/nyu-core/actions/runs/6114327406): Started a detailed outline of how the control module will work.
  
This week was spent mostly working on the MEM/WB latch module as well as starting the detailed outline describing how the general control module will work. I also spent some time cleaning up the repository by fixing spelling mistakes, removing old assignments, and more so that it is ready for the new semester and new students. Overall, the Core repo is now in a place where new students can easily be on-boarded into Core and given a task to work on.

At this point all the outlines for the simpler modules are completed, which means I need to start finalizing the designs of things like the branch predictor, caches, and more. For very complex modules like the general control module, I plan to have more detailed descriptions of their functionality in addition to the standard outlines. As mentioned, I have started the one for the general control module and others will hopefully follow soon. I am also hoping this semester that one or two of the students on the Core team will have enough experience to be able to help me with design decisions and outlining; this is especially true regarding double-checking work and troubleshooting. As more of the core is completed, fixing bugs in module interaction or instruction execution will require someone with detailed knowledge of the overall design, and I'd like to be able to delegate bug fixing and troubleshooting to other people so that it doesn't take up all my time and slow down our progress.

## Week of September 18, 2023

Project Work:
* [Added More Instruction Decoding Detail to General Control Module Documentation](https://github.com/NYU-Processor-Design/nyu-core/commit/210827f956ca855883031ee3402a26ae4708033e): Added more specified output details to the different instruction types.
* [Merged Hazard Detection Module into General Control Module](https://github.com/NYU-Processor-Design/nyu-core/commit/4e8ccf7310ae49454d8b36c4377737d8aab21523): Decided to merge the hazard detection module into the general control module to reduce redundant inputs and registers, since both modules would have had very similar inputs and internal registers. Started documenting the hazard detection functionality in the general control module functionality document.
* [Added NOP instruction description to General Control Module Documentation](https://github.com/NYU-Processor-Design/nyu-core/commit/bce8dd3e52b0774d6eb3f71852de27794c9c350d): Added the decoding steps for the NOP instruction that will be used to stall the pipeline to prevent data hazards.
* [Updated ID/EX Latch Docs](https://github.com/NYU-Processor-Design/nyu-core/commit/1c681230fc072e42237b54ab1ce0131fedf96714): Updated the ID/EX Latch Documentation with the new a_sel line and new values for b_sel line to allow the Load Upper IMM and Add Upper IMM to PC instructions to work.
* [Fixed Branch Evaluator Docs](https://github.com/NYU-Processor-Design/nyu-core/commit/7443972dffcd0d2548776b7edbf27b8c1a1f37e5): Fixed the way the ALU output for branch conditions 1 and 2 is evaluated. Instead of taking the full output, it is now bitwise ORed together to get either a 1 or 0.
* [Moved Branch Prediction to ID phase](https://github.com/NYU-Processor-Design/nyu-core/commit/c24b757b02da6a75e164b53b0e338213eb02f5fc): Updated the Branch Address Calculator to output the predicted next program counter value so that it can be immediately fed back to the program counter, making branch prediction happen in the ID phase rather than the EX phase.
* [Updated CPU Block Diagram](https://github.com/NYU-Processor-Design/nyu-core/commit/c09d756adda8aac37d928cf1a273eb772b7df26f): Updated the CPU Block Diagram in the ReadMe to reflect the changes made to the general control module, merging the hazard detection module into the general control module, the new inputs for the branch address calculator module, the new a_sel line for the ID/EX latch, and the new pc_en line for the program counter.
* [Merged Uma's General Purpose Register Module](https://github.com/NYU-Processor-Design/nyu-core/pull/51): Worked with Uma to remind her of the changes she needed to make to the register module and then merged her completed module and test into the core repo.

This week was primarily spent working on the documentation for the General Control Module. I added more specific output details to each instruction type as well as merged the hazard detection logic into the General Control Module. Most of the details for the instruction have now been added and what remains should be added shortly. In terms of the complete documentation for all functions of the General Control Module, I'd give a rough estimate that we are 40% complete, as while instruction decoding is almost fully documented, I have only just started on the data hazard detection portion of the documentation and have not yet started on handling branch prediction hazards, how the branch manager and control module will interact to deal with branching hazards and flushing the pipeline, or how to handle initialization of the core on startup.

While updating the Control Module Documentation, I discovered several oversights I made in the overall core design regarding the execution of specific instructions and branch prediction. To fix the instruction oversights, I added a few more control lines to select new parameters that would allow instructions such as Load Upper IMM to function properly. I also realized that if I moved branch prediction handling from the branch manager to the branch address calculator, we could save an entire clock cycle and predict in the ID phase rather than the EX phase.

Finding and fixing various oversights in the core design reinforced the idea that I need to find one or two knowledgeable Core Team members to meet with and give a detailed overview of the RISC-V ISA and current core design so that they can help make design decisions, help troubleshoot, and most importantly, double check my work so that mistakes are caught and correctly early on. Thankfully, we have a much larger team this semester so I am hopeful I'll be able to find one or two students with enough initiative and aptitude to take on this responsibility.

## Week of September 25, 2023

Project Work:
* [Started Outline of Branch Manager Module](https://github.com/NYU-Processor-Design/nyu-core/commit/206c04fbb02cfed3a17b0fa593118dc4f3337808): Started the outline for the Branch Manager Module
* [Updated wbs numbering](https://github.com/NYU-Processor-Design/nyu-core/commit/60bbc415a163fbafc49267efe5393c17ea06f409): Updated the numbering for the wbs input to the MEM/WB Latch Module so that we can just use the func3 directly from the instruction to determine wbs for the different load sizes.
* [Updated General Control Module Complex Functionality Document](https://github.com/NYU-Processor-Design/nyu-core/commit/ca0599d3d4bd9e80b6fcb318fa7281c9ff4da2fc): Updated the complex functionality document for the General Control Module with more outputs for the I instructions, NPC input, and pc_en output.
* [Started Complex Functionality Outline for Branch Prediction Module](https://github.com/NYU-Processor-Design/nyu-core/commit/69236c1b072599031cd8495b9cc3a82ba3971fb7): Started the basic outline for the Complex Functionality document for the Branch Prediction Module

This week was spent on a variety of things, msot of which were design documentation related. I continued my work on the functionality documentation for the General Control Module, adding missing inputs and outputs and continuing to fill in the various instruction decode outputs. I also started work on the functionality documentation for the Branch Prediction Module as I now have most of the components surrounding it finalized so I can begin working on its functionality in more detail. 

I also did some optimization to the MEM/WB latch's wbs input. This input determines the source of the data written to the destination register and my inital numbering system proved to be inefficent when trying to decode the load instructions. While adding the General Control Module outputs for the load instructions, I realized that the func3 of the load instruction could directly corrospond to the wbs, and so changed the wbs numbering scheme to be a direct 1-1 with the func3 numbering of the Load instructions, with the wbs number corresponding to the ALU, something not used by the load instructions, neatly corresponding to the unused load func3 value of 3.

The new members who joined this semester should hopefully start finishing their labs next week, meaning implemntation of the already outlined modules and the needed interfaces should pick up. On-boarding people to Core should be relativley smooth as there is plenty of detailed implemntation work they can go ahead and start.
